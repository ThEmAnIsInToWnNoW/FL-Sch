<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Forest Lake ‚Äì Bell Schedule</title>
<style>
:root{
  --bg:#f4f4f9; --text:#222; --card:#fff; --accent:#800000; --accent-strong:#4CAF50;
  --border:#dcd7df; --muted:#666; --fab-red:#8b0000; --base-font-size:16px;
}
html{font-size:var(--base-font-size);}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
.app{max-width:1100px;margin:22px auto;padding:18px;background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 10px 30px rgba(20,20,30,0.04);}

/* Header / status */
h1{margin:0;color:var(--accent);font-size:1.3rem}
.meta{font-size:.9rem;color:var(--muted);margin-top:6px}
.status-card{margin-top:16px;padding:14px;border-radius:10px;border:1px solid var(--border);display:flex;gap:18px;align-items:center;flex-wrap:wrap}
#current-time{font-weight:700;font-size:1.15rem;color:var(--accent-strong);min-width:120px}
.status-info{display:flex;flex-direction:column;gap:6px;flex:1}
#current-period{font-weight:600}
#time-left{font-weight:normal;color:var(--accent-strong)}
.local-text{margin-left:auto;font-size:.88rem;color:var(--muted)}

/* schedule table */
table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem}
th,td{padding:8px 6px;border:1px solid var(--border);text-align:left}
th{background:var(--accent);color:var(--card);text-transform:uppercase;font-size:.75rem}
td.period-time{white-space:nowrap}
td.highlight{background:rgba(76,175,80,0.10);font-weight:700;color:var(--accent-strong);border:2px solid rgba(76,175,80,0.12)}

/* week / events */
.week-wrap{margin-top:12px;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card)}
.week-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.nav{display:flex;gap:6px}
#week-range{font-weight:700;color:var(--muted)}

/* responsive grid/cards for days */
.week-grid{display:grid;gap:10px;margin-top:12px;grid-template-columns: repeat(5, minmax(140px,1fr));}
.day{border-radius:10px;border:1px solid var(--border);overflow:hidden;background:var(--card)}
.day details{border-radius:10px}
.day summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;font-weight:700;color:var(--accent)}
.day summary::-webkit-details-marker{display:none}
.day-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;font-weight:700;color:var(--accent);background:transparent}
.date{font-size:.8rem;padding:3px 6px;border-radius:6px;background:rgba(0,0,0,0.03);color:var(--muted)}
.day.today{box-shadow:0 0 0 3px var(--accent-strong) inset;border:2px solid var(--accent-strong)}
.events{display:flex;flex-direction:column;gap:8px;padding:10px 12px 12px}
.ev{background:rgba(76,175,80,0.08);padding:8px 10px;border-radius:8px;border:1px solid var(--border);font-size:.95rem;line-height:1.35;color:var(--text)}
.ev.no-school{background:rgba(255,87,34,0.1);border-color:rgba(255,87,34,0.3);font-weight:600}
.ev.small{opacity:.7;font-size:.9rem}
.week-grid.seven .ev{font-size:.85rem;line-height:1.3;word-break:break-word}

/* FAB */
.fab-wrap{position:fixed;right:20px;bottom:20px;z-index:1600;display:flex;align-items:flex-end;gap:8px}
#fab-main{width:56px;height:56px;border-radius:50%;background:var(--fab-red);color:#fff;border:0;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 14px 36px rgba(0,0,0,0.25);cursor:pointer;transition:transform .18s}
#fab-main:hover{transform:scale(1.05)}
.slide-layer{display:flex;gap:8px;align-items:flex-end;pointer-events:none}
.slide-layer.inactive{pointer-events:none;visibility:hidden}
.slide-item{display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:auto}
.slide-label{font-weight:700;font-size:.7rem;margin-bottom:2px;color:var(--muted);opacity:0;transform:translateY(6px);transition:opacity .28s, transform .28s}
.slide-btn{width:48px;height:48px;border-radius:50%;background:var(--accent);color:white;border:0;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,0.18);cursor:pointer;font-size:20px;transform:translateX(120%) scale(.8);opacity:0;filter:blur(8px);transition:transform .38s cubic-bezier(.22,.9,.29,1),opacity .28s,filter .38s;pointer-events:none}
.slide-btn.show{transform:translateX(0) scale(1);opacity:1;filter:blur(0);pointer-events:auto}
.slide-label.show{opacity:1;transform:translateY(0)}

/* modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-card{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--border);width:420px;max-width:95%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-card h3{margin-top:0;color:var(--accent);font-size:1.1rem}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:.95rem}
.setting-row:last-child{border-bottom:none}
.btn{background:var(--card);border:1px solid var(--border);padding:6px 12px;border-radius:8px;cursor:pointer;color:var(--text);transition:all .18s;font-size:0.9rem}
.btn:hover{background:var(--border)}
select,input[type=checkbox]{padding:6px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text)}

/* theme palette */
.theme-palette{position:fixed;bottom:90px;right:20px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.3);z-index:1700;transform:scale(0) translateY(20px);opacity:0;transition:transform .3s cubic-bezier(.68,-.55,.265,1.55),opacity .3s;pointer-events:none}
.theme-palette.active{transform:scale(1) translateY(0);opacity:1;pointer-events:auto}
.theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
.theme-option{width:36px;height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:transform .18s,border-color .18s}
.theme-option:hover{transform:scale(1.06)}
.theme-option.active{border-color:var(--accent-strong);box-shadow:0 0 0 3px rgba(76,175,80,.2)}

/* theme variables per body class */
body.theme-default{
  --bg:#f4f4f9; --text:#222; --card:#ffffff; --accent:#800000; --accent-strong:#4CAF50;
  --border:#dcd7df; --muted:#666; --fab-red:#8b0000;
}
body.theme-ocean{
  --bg:#e3f2fd; --text:#0b2942; --card:#ffffff; --accent:#0277bd; --accent-strong:#039be5;
  --border:#c5d9ef; --muted:#4a6a88; --fab-red:#01579b;
}
body.theme-forest{
  --bg:#e8f5e9; --text:#1b311f; --card:#ffffff; --accent:#2e7d32; --accent-strong:#43a047;
  --border:#cfe6d2; --muted:#43624a; --fab-red:#1b5e20;
}
body.theme-sunset{
  --bg:#fff3e0; --text:#5a3300; --card:#ffffff; --accent:#f57c00; --accent-strong:#fb8c00;
  --border:#f3d7b4; --muted:#8a5c2b; --fab-red:#e65100;
}
body.theme-lavender{
  --bg:#f3e5f5; --text:#2e123f; --card:#ffffff; --accent:#7b1fa2; --accent-strong:#9c27b0;
  --border:#e0c9e7; --muted:#624b6d; --fab-red:#6a1b9a;
}
body.theme-mint{
  --bg:#e0f2f1; --text:#0f3a37; --card:#ffffff; --accent:#00695c; --accent-strong:#00897b;
  --border:#c2e3e1; --muted:#3d6663; --fab-red:#004d40;
}
body.theme-midnight{
  --bg:#0a0e27; --text:#e8ebff; --card:#12183a; --accent:#4c5fd5; --accent-strong:#6c7cff;
  --border:#2a3163; --muted:#aab1e6; --fab-red:#3949ab;
}
body.theme-coffee{
  --bg:#1c1410; --text:#f2e7dc; --card:#2a1e18; --accent:#8b4513; --accent-strong:#a05a2a;
  --border:#3b2a21; --muted:#c8b6a6; --fab-red:#6d3a12;
}
body.theme-purple-haze{
  --bg:#1a0f2e; --text:#efe7ff; --card:#251743; --accent:#7c3aed; --accent-strong:#a78bfa;
  --border:#3a2a66; --muted:#cabaf2; --fab-red:#5b21b6;
}
body.theme-dark-mode{
  --bg:#0f1113; --text:#e6e6e6; --card:#14171a; --accent:#b54b4b; --accent-strong:#48c774;
  --border:#2a2f34; --muted:#a3a7ab; --fab-red:#a03a3a;
}

/* responsive tweaks */
@media (max-width:900px){ .week-grid{grid-template-columns:1fr} }
@media (max-width:768px){
  .status-card{flex-direction:column;align-items:flex-start}
  .local-text{margin-left:0}
  #fab-main{width:56px;height:56px;font-size:26px}
  .slide-label{display:none}
  .week-grid{display:flex;flex-direction:column;gap:10px;max-height:68vh;overflow-y:auto}
}

/* ensure FAB wrapper doesn't block by default (no :has fallback reliance) */
.fab-wrap-disable { pointer-events: none !important; }
.fab-wrap-enable { pointer-events: auto !important; }
</style>
</head>
<body class="theme-default">
<div class="app">
  <header style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
    <div>
      <h1>Forest Lake ‚Äì Bell Schedule</h1>
      <div class="meta">2025‚Äì2026 School Year</div>
    </div>
  </header>

  <div class="status-card">
    <div id="current-time">--:--:-- --</div>
    <div class="status-info">
      <div id="current-period">Loading schedule...</div>
      <div><span id="time-left-label">Time left:</span> <span id="time-left">--</span></div>
    </div>
    <div class="local-text">Local Time</div>
  </div>

  <section>
    <h2 style="margin-top:20px;color:var(--accent)">Bell Schedule</h2>
    <table id="schedule-table">
      <thead>
        <tr><th>Period</th><th>Mon, Tue, Thu, Fri</th><th>Wed (Ranger Connect)</th></tr>
      </thead>
      <tbody>
        <tr><td>1</td><td class="period-time">7:45am - 8:35am</td><td class="period-time">7:45am - 8:30am</td></tr>
        <tr><td>2</td><td class="period-time">8:40am - 9:30am</td><td class="period-time">8:35am - 9:25am</td></tr>
        <tr><td>3</td><td class="period-time">9:35am - 10:25am</td><td class="period-time">9:30am - 10:15am</td></tr>
        <tr><td>4</td><td class="period-time">10:30am - 11:20am</td><td class="period-time">10:20am - 11:05am</td></tr>
        <tr><td>Ranger Connect</td><td class="period-time">-</td><td class="period-time">11:10am - 11:35am</td></tr>
        <tr><td>5</td><td class="period-time">11:25am - 12:40pm</td><td class="period-time">11:40am - 12:50pm</td></tr>
        <tr><td>A Lunch</td><td class="period-time">11:20am - 11:50am</td><td class="period-time">11:35am - 12:05pm</td></tr>
        <tr><td>B Lunch</td><td class="period-time">11:45am - 12:15pm</td><td class="period-time">12:00pm - 12:30pm</td></tr>
        <tr><td>C Lunch</td><td class="period-time">12:15pm - 12:45pm</td><td class="period-time">12:25pm - 12:55pm</td></tr>
        <tr><td>6</td><td class="period-time">12:45pm - 1:35pm</td><td class="period-time">12:55pm - 1:40pm</td></tr>
        <tr><td>7</td><td class="period-time">1:40pm - 2:30pm</td><td class="period-time">1:45pm - 2:30pm</td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <div style="text-align:center;margin-top:20px">
      <h2 style="margin:0 0 10px 0;color:var(--accent)">School Events & Calendar</h2>
      <button class="btn" id="toggle-events-section">Hide Events üìÖ</button>
    </div>

    <div id="events-section" style="display:block;margin-top:12px">
      <div class="week-wrap">
        <div class="week-head">
          <div class="nav">
            <button class="btn" id="prev-week">‚Üê Prev</button>
            <button class="btn" id="next-week">Next ‚Üí</button>
          </div>
          <div id="week-range">Loading...</div>
          <div>
            <button class="btn" id="return-week" style="display:none">Current Week</button>
          </div>
        </div>

        <div id="week-grid" class="week-grid"></div>
      </div>
    </div>
  </section>
</div>

<!-- FAB -->
<div id="fab-wrap" class="fab-wrap fab-wrap-disable">
  <button id="fab-main" aria-label="Menu">+</button>
  <div class="slide-layer inactive" id="slide-layer">
    <div class="slide-item"><div class="slide-label">Bookmark</div><button class="slide-btn" id="btn-bookmark" title="Bookmark">üîñ</button></div>
    <div class="slide-item"><div class="slide-label">Download</div><button class="slide-btn" id="btn-download" title="Download">‚¨áÔ∏è</button></div>
    <div class="slide-item"><div class="slide-label">Share</div><button class="slide-btn" id="btn-share" title="Share">üì§</button></div>
    <div class="slide-item"><div class="slide-label">Theme</div><button class="slide-btn" id="btn-theme" title="Theme">üé®</button></div>
    <div class="slide-item"><div class="slide-label">Settings</div><button class="slide-btn" id="btn-settings" title="Settings">‚öôÔ∏è</button></div>
  </div>
</div>

<!-- Theme palette -->
<div class="theme-palette" id="theme-palette">
  <h4>Choose Theme</h4>
  <div class="theme-grid">
    <div class="theme-option active" data-theme="default" title="Default" style="background:linear-gradient(135deg,#f4f4f9 50%,#800000 50%)"></div>
    <div class="theme-option" data-theme="ocean" title="Ocean" style="background:linear-gradient(135deg,#e3f2fd 50%,#0277bd 50%)"></div>
    <div class="theme-option" data-theme="forest" title="Forest" style="background:linear-gradient(135deg,#e8f5e9 50%,#2e7d32 50%)"></div>
    <div class="theme-option" data-theme="sunset" title="Sunset" style="background:linear-gradient(135deg,#fff3e0 50%,#f57c00 50%)"></div>
    <div class="theme-option" data-theme="lavender" title="Lavender" style="background:linear-gradient(135deg,#f3e5f5 50%,#7b1fa2 50%)"></div>
    <div class="theme-option" data-theme="mint" title="Mint" style="background:linear-gradient(135deg,#e0f2f1 50%,#00695c 50%)"></div>
    <div class="theme-option" data-theme="midnight" title="Midnight" style="background:linear-gradient(135deg,#0a0e27 50%,#4c5fd5 50%)"></div>
    <div class="theme-option" data-theme="coffee" title="Coffee" style="background:linear-gradient(135deg,#1c1410 50%,#8b4513 50%)"></div>
    <div class="theme-option" data-theme="purple-haze" title="Purple Haze" style="background:linear-gradient(135deg,#1a0f2e 50%,#7c3aed 50%)"></div>
    <div class="theme-option" data-theme="dark-mode" title="Dark Mode" style="background:linear-gradient(135deg,#0f1113 50%,#b54b4b 50%)"></div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settings-modal">
  <div class="modal-card">
    <h3>‚öôÔ∏è Settings</h3>
    <div class="setting-row">
      <label>Time Format</label>
      <select id="time-format"><option value="12">12-hour</option><option value="24">24-hour</option></select>
    </div>
    <div class="setting-row">
      <label>Show Seconds</label>
      <input type="checkbox" id="show-seconds" checked />
    </div>
    <div class="setting-row">
      <label>Show Milliseconds</label>
      <input type="checkbox" id="show-milliseconds" />
    </div>
    <div class="setting-row">
      <label>Week Type</label>
      <select id="week-type"><option value="5" selected>5-day (Mon‚ÄìFri)</option><option value="7">7-day (Sun‚ÄìSat)</option></select>
    </div>
    <div style="text-align:right;margin-top:14px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn" id="reset-week-type">Reset to 5-day</button>
      <button class="btn" id="close-settings">Close</button>
    </div>
  </div>
</div>

<script>
/* ========== Data (hard-coded) ========== */
const SCHOOL_EVENTS = [
  { start: '2025-09-02', end: '2025-09-02', title: 'First day | K-5, 6, 9 & STEP' },
  { start: '2025-09-03', end: '2025-09-03', title: 'First day | 7, 10-12' },
  { start: '2025-09-04', end: '2025-09-04', title: 'First day | Grade 8' },
  { start: '2025-10-16', end: '2025-10-17', title: 'No School | Fall break' },
  { start: '2025-10-31', end: '2025-10-31', title: 'End of Quarter 1' },
  { start: '2025-11-26', end: '2025-11-28', title: 'No School | Thanksgiving Break' },
  { start: '2025-12-24', end: '2026-01-02', title: 'No School | Winter Break' },
  { start: '2026-06-04', end: '2026-06-04', title: 'Last day | K-12 & STEP' }
];

/* ========== Utilities ========== */
const parseISO = s => { const [y,m,d] = s.split('-').map(Number); return new Date(y,m-1,d); };
const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const dateEq = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
const addDays = (d,n) => { const r=new Date(d.getFullYear(),d.getMonth(),d.getDate()); r.setDate(r.getDate()+n); return r; };
const eventsForDate = d => SCHOOL_EVENTS.filter(ev => { const s = parseISO(ev.start); const e = parseISO(ev.end); return ymd(s) <= ymd(d) && ymd(e) >= ymd(d); });

/* ========== Schedule clock ========== */
const SCHEDULE = [
  { period: "1", monFri: "7:45-8:35", wed: "7:45-8:30" },
  { period: "2", monFri: "8:40-9:30", wed: "8:35-9:25" },
  { period: "3", monFri: "9:35-10:25", wed: "9:30-10:15" },
  { period: "4", monFri: "10:30-11:20", wed: "10:20-11:05" },
  { period: "Ranger Connect", monFri: "", wed: "11:10-11:35" },
  { period: "5", monFri: "11:25-12:40", wed: "11:40-12:50" },
  { period: "A Lunch", monFri: "11:20-11:50", wed: "11:35-12:05" },
  { period: "B Lunch", monFri: "11:45-12:15", wed: "12:00-12:30" },
  { period: "C Lunch", monFri: "12:15-12:45", wed: "12:25-12:55" },
  { period: "6", monFri: "12:45-13:35", wed: "12:55-13:40" },
  { period: "7", monFri: "13:40-14:30", wed: "13:45-14:30" }
];

let settings = { timeFormat:12, showSeconds:true, showMilliseconds:false };
let scheduleTimer = null;
let clockAnimTimer = null;

/* ========== Week state ========== */
/* default is 5; if user switches to 7 it stays during session until reload */
let weekType = '5'; // '5' or '7'
let now = new Date();
let currentWeekStart = startOfWeek(now, true); // Monday start
let viewingWeekStart = new Date(currentWeekStart);

/* helper: start of week (Monday default) */
function startOfWeek(d, monday=true){
  const c = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  let day = c.getDay(); // 0 Sun ... 6 Sat
  if (monday) { day = (day === 0 ? 7 : day); c.setDate(c.getDate() - (day - 1)); }
  else { c.setDate(c.getDate() - day); }
  return new Date(c.getFullYear(), c.getMonth(), c.getDate());
}

/* ========== Render week (collapsible day cards) ========== */
function renderWeek(weekStart){
  const weekGrid = document.getElementById('week-grid');
  const weekRange = document.getElementById('week-range');
  weekGrid.innerHTML = '';

  const days = (weekType === '7') ? 7 : 5;
  const start = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
  const end = addDays(start, days - 1);
  weekRange.textContent = `${start.toLocaleDateString(undefined,{month:'short',day:'numeric'})} ‚Äì ${end.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'})}`;

  // adjust grid columns for desktop
  if (window.innerWidth > 900) {
    document.getElementById('week-grid').style.gridTemplateColumns = (weekType==='7') ? 'repeat(7,minmax(120px,1fr))' : 'repeat(5,minmax(140px,1fr))';
  }

  // mark grid for style tweaks on 7-day
  if (weekType === '7') weekGrid.classList.add('seven'); else weekGrid.classList.remove('seven');

  for (let i=0;i<days;i++){
    const day = addDays(start, i);
    const isWeekend = (day.getDay()===0 || day.getDay()===6);
    const card = document.createElement('div'); card.className='day';
    if (dateEq(day,new Date())) card.classList.add('today');

    const head = document.createElement('div'); head.className='day-head';
    const weekday = day.toLocaleDateString(undefined, { weekday: 'short' });
    const monthday = day.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    head.innerHTML = `<span>${weekday}</span><span class="date">${monthday}</span>`;

    const evwrap = document.createElement('div'); evwrap.className='events';
    const evs = eventsForDate(day);

    if (evs.length === 0) {
      // If 7-day and weekend with no events, skip explicit "No events" (per your request)
      if (!(weekType === '7' && isWeekend)) {
        const e = document.createElement('div'); e.className='ev small'; e.textContent = 'No events'; evwrap.appendChild(e);
      }
    } else {
      const shown = new Set();
      evs.forEach(ev => {
        const cleaned = ev.title.replace(/\s*\|\s*/g, ' | ');
        if (!shown.has(cleaned)) {
          const e = document.createElement('div'); e.className='ev';
          if (cleaned.toLowerCase().includes('no school')) e.classList.add('no-school');
          e.textContent = cleaned;
          evwrap.appendChild(e);
          shown.add(cleaned);
        }
      });
    }

    card.appendChild(head);
    card.appendChild(evwrap);
    weekGrid.appendChild(card);
  }

  // show/hide return-week button
  document.getElementById('return-week').style.display = (ymd(weekStart) === ymd(currentWeekStart)) ? 'none' : 'inline-block';
}

/* ========== Week navigation handlers ========== */
document.getElementById('prev-week').addEventListener('click', () => { viewingWeekStart = addDays(viewingWeekStart, -7); renderWeek(viewingWeekStart); });
document.getElementById('next-week').addEventListener('click', () => { viewingWeekStart = addDays(viewingWeekStart, 7); renderWeek(viewingWeekStart); });
document.getElementById('return-week').addEventListener('click', () => { viewingWeekStart = new Date(currentWeekStart); renderWeek(viewingWeekStart); });

/* Toggle events section */
document.getElementById('toggle-events-section').addEventListener('click', () => {
  if (menuOpen) toggleMenu(false);
  const eventsSection = document.getElementById('events-section');
  const btn = document.getElementById('toggle-events-section');
  const willShow = (eventsSection.style.display === 'none');
  eventsSection.style.display = willShow ? 'block' : 'none';
  btn.textContent = willShow ? 'Hide Events üìÖ' : 'Show Events üìÖ';
  if (willShow) renderWeek(viewingWeekStart);
});

/* ========== Schedule clock logic ========== */
function timeToMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60 + m; }
function formatCountdown(minutes){ if (minutes<=0) return "0m 00s"; const m=Math.floor(minutes); const s=Math.round((minutes-m)*60); return `${m}m ${String(s).padStart(2,'0')}s`; }
function formatTime(date){
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2,'0');
  const seconds = String(date.getSeconds()).padStart(2,'0');
  let ampm = '';
  if (settings.timeFormat === 12) { ampm = hours>=12?' PM':' AM'; hours = hours%12; hours = hours?hours:12; }
  const formattedHours = String(hours);
  let timeString = `${formattedHours}:${minutes}`;
  if (settings.showSeconds) timeString += `:${seconds}`;
  if (settings.showMilliseconds) timeString += `.${String(date.getMilliseconds()).padStart(3,'0')}`;
  return timeString + ampm;
}
function formatTimeNoMs(date){
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2,'0');
  const seconds = String(date.getSeconds()).padStart(2,'0');
  let ampm = '';
  if (settings.timeFormat === 12) { ampm = hours>=12?' PM':' AM'; hours = hours%12; hours = hours?hours:12; }
  const formattedHours = String(hours);
  let timeString = `${formattedHours}:${minutes}`;
  if (settings.showSeconds) timeString += `:${seconds}`;
  return timeString + ampm;
}
function updateSchedule(){
  const now = new Date(); document.getElementById('current-time').textContent = formatTime(now);
  const day = now.getDay(); const isWeekend = (day===0||day===6); const isWed = (day===3);
  if (isWeekend) { document.getElementById('current-period').textContent = 'School is OUT ‚Äì Enjoy the weekend!'; document.getElementById('time-left').textContent = ''; highlightSchedule(null); return; }
  const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
  const dayKey = isWed ? 'wed' : 'monFri';
  const applicable = SCHEDULE
    .filter(s => s[dayKey])
    .map(s => { const [start,end] = s[dayKey].split('-'); return {...s, startMin:timeToMinutes(start), endMin:timeToMinutes(end)}; })
    .sort((a,b)=>a.startMin-b.startMin);

  const activeNow = applicable.filter(item => nowMin >= item.startMin && nowMin < item.endMin);
  const lunchesNow = activeNow.filter(i => /Lunch/i.test(i.period));

  if (lunchesNow.length > 0){
    const endSoonest = Math.min(...lunchesNow.map(i => i.endMin));
    const endTime = new Date(); endTime.setHours(Math.floor(endSoonest/60), endSoonest % 60, 0);
    const lunchLabels = lunchesNow.map(i => i.period.replace(' Lunch','')).join(' & ');
    document.getElementById('current-period').textContent = `Current: Lunch (${lunchLabels}) (ends ${formatTimeNoMs(endTime)})`;
    document.getElementById('time-left').textContent = formatCountdown(endSoonest - nowMin);
    highlightSchedule(lunchesNow.map(i => i.period), isWed);
    return;
  }

  const current = activeNow[0] || null;
  let next = null;
  for (const item of applicable){
    if (nowMin < item.startMin) { next = item; break; }
  }

  if (current){
    const endTime = new Date(); endTime.setHours(Math.floor(current.endMin/60), current.endMin % 60, 0);
    const label = /Lunch/i.test(current.period) ? current.period : `Period ${current.period}`;
    document.getElementById('current-period').textContent = `Current: ${label} (ends ${formatTimeNoMs(endTime)})`;
    document.getElementById('time-left').textContent = formatCountdown(current.endMin - nowMin);
    highlightSchedule([current.period], isWed);
  } else if (next){
    document.getElementById('current-period').textContent = 'Passing Time / Break';
    document.getElementById('time-left').textContent = `Next: Period ${next.period} starts in ${formatCountdown(next.startMin - nowMin)}`;
    highlightSchedule(null);
  } else {
    document.getElementById('current-period').textContent = 'Before school hours';
    document.getElementById('time-left').textContent = 'School starts at 7:45 AM';
    highlightSchedule(null);
  }
}
function highlightSchedule(currentPeriods, isWed=false){
  document.querySelectorAll('#schedule-table tbody td').forEach(td => td.classList.remove('highlight'));
  if (!currentPeriods) return;
  const targetSet = new Set(Array.isArray(currentPeriods) ? currentPeriods : [currentPeriods]);
  const rows = document.querySelectorAll('#schedule-table tbody tr');
  rows.forEach(row => {
    const p = row.cells[0].textContent.trim();
    if (targetSet.has(p)) {
      const col = isWed ? 2 : 1;
      const cell = row.cells[col];
      if (cell) cell.classList.add('highlight');
    }
  });
}

/* ========== FAB (non-blocking) ========== */
/* We'll control pointer-events on the wrapper to ensure underlying UI is reachable when menu closed */
let menuOpen = false;
const fab = document.getElementById('fab-main');
const slideLayer = document.getElementById('slide-layer');
const slideItems = Array.from(document.querySelectorAll('.slide-item'));
const fabWrap = document.getElementById('fab-wrap');

fabWrap.classList.add('fab-wrap-disable');
fab.style.pointerEvents = 'auto';
slideLayer.style.visibility = 'hidden';
slideLayer.classList.add('inactive');

function toggleMenu(open){
  menuOpen = open;
  fab.textContent = open ? '‚úï' : '+';
  if (open){
    // enable wrapper
    fabWrap.classList.remove('fab-wrap-disable');
    fabWrap.classList.add('fab-wrap-enable');
    slideLayer.style.visibility = 'visible';
    slideLayer.classList.remove('inactive');
    slideItems.forEach((it,i) => {
      const btn = it.querySelector('.slide-btn');
      const label = it.querySelector('.slide-label');
      setTimeout(()=>{ btn.classList.add('show'); label.classList.add('show'); }, i*80);
    });
  } else {
    // reverse show
    slideItems.slice().reverse().forEach((it,idx) => {
      const btn = it.querySelector('.slide-btn');
      const label = it.querySelector('.slide-label');
      setTimeout(()=>{ btn.classList.remove('show'); label.classList.remove('show'); }, idx*50);
    });
    // after animations, hide layer and disable wrapper pointer events
    setTimeout(()=>{
      slideLayer.classList.add('inactive');
      slideLayer.style.visibility = 'hidden';
      fabWrap.classList.remove('fab-wrap-enable');
      fabWrap.classList.add('fab-wrap-disable');
      fab.style.pointerEvents = 'auto';
    },500);
  }
}
fab.addEventListener('click', ()=> toggleMenu(!menuOpen));
/* close menu by clicking outside */
document.addEventListener('click', (e) => {
  if (!document.getElementById('fab-wrap').contains(e.target) && !document.getElementById('theme-palette').contains(e.target) && menuOpen){
    toggleMenu(false);
  }
});

/* ========== Settings modal (week-type persists during session only) ========== */
const settingsModal = document.getElementById('settings-modal');
const weekTypeSelect = document.getElementById('week-type');

document.getElementById('btn-settings').addEventListener('click', () => {
  toggleMenu(false);
  weekTypeSelect.value = weekType;
  // reflect current time settings also
  document.getElementById('time-format').value = settings.timeFormat;
  document.getElementById('show-seconds').checked = settings.showSeconds;
  document.getElementById('show-milliseconds').checked = settings.showMilliseconds;
  settingsModal.classList.add('active');
});

function closeSettings(){
  settingsModal.classList.remove('active');
  // don't reset weekType on close; persist until reload (session)
}

document.getElementById('close-settings').addEventListener('click', closeSettings);
settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });

/* settings controls */
document.getElementById('time-format').addEventListener('change', (e)=>{ settings.timeFormat = parseInt(e.target.value); updateSchedule(); });
document.getElementById('show-seconds').addEventListener('change', (e)=>{ settings.showSeconds = e.target.checked; updateSchedule(); });
document.getElementById('show-milliseconds').addEventListener('change', (e)=>{ settings.showMilliseconds = e.target.checked; startScheduleTimer(); startClockAnimator(); updateSchedule(); });

weekTypeSelect.addEventListener('change', (e)=>{
  weekType = e.target.value;
  // When switching to 7-day, compute viewingWeekStart to include Sunday if needed:
  // Keep the same start-of-week logic: viewingWeekStart remains anchored to Monday for 5-day.
  renderWeek(viewingWeekStart);
});

/* Reset button (sets back to 5 but does not reload) */
document.getElementById('reset-week-type').addEventListener('click', ()=>{
  weekType = '5';
  weekTypeSelect.value = '5';
  renderWeek(viewingWeekStart);
});

/* ========== Theme palette ========== */
const themePalette = document.getElementById('theme-palette');
const themeOptions = document.querySelectorAll('.theme-option');
document.getElementById('btn-theme').addEventListener('click', () => { toggleMenu(false); themePalette.classList.toggle('active'); });
themeOptions.forEach(opt => opt.addEventListener('click', () => {
  const t = opt.dataset.theme;
  // map token name to your CSS body class naming scheme
  if (t === 'default') document.body.className = 'theme-default';
  else document.body.className = `theme-${t}`;
  themeOptions.forEach(o => o.classList.remove('active'));
  opt.classList.add('active');
  themePalette.classList.remove('active');
}));

/* timer control
   - schedule timer: always every 1000ms to keep logic in sync with real seconds
   - clock animator: fast UI-only updates for milliseconds when enabled
*/
function startScheduleTimer(){
  if (scheduleTimer) { clearInterval(scheduleTimer); scheduleTimer = null; }
  scheduleTimer = setInterval(updateSchedule, 1000);
}
function startClockAnimator(){
  if (clockAnimTimer) { clearInterval(clockAnimTimer); clockAnimTimer = null; }
  if (!settings.showMilliseconds) return;
  const target = document.getElementById('current-time');
  clockAnimTimer = setInterval(()=>{
    // UI-only refresh for smooth milliseconds, stays synced because we read Date.now()
    const now = new Date();
    target.textContent = formatTime(now);
  }, 50);
}

/* ========== Share / Download / Bookmark ========== */
document.getElementById('btn-share').addEventListener('click', async () => {
  toggleMenu(false);
  const shareData = { title: document.title, text: 'Forest Lake Bell Schedule', url: location.href };
  if (navigator.share) {
    try { await navigator.share(shareData); } catch (e) {}
  } else {
    try { await navigator.clipboard.writeText(location.href); alert('Link copied to clipboard!'); }
    catch (e) { alert('Copy failed: ' + e); }
  }
});

document.getElementById('btn-download').addEventListener('click', () => {
  toggleMenu(false);
  const html = '<!DOCTYPE html>\\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'forest-lake-bell-schedule.html';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('btn-bookmark').addEventListener('click', () => {
  toggleMenu(false);
  try { if (window.external && ('AddFavorite' in window.external)) { window.external.AddFavorite(location.href, document.title); return; } } catch(e){}
  alert('To bookmark this page: press Ctrl+D (Windows) or Cmd+D (Mac).');
});

/* ========== Initialization ========== */
function renderInitial(){
  renderWeek(viewingWeekStart);
  updateSchedule();
  startScheduleTimer();
  startClockAnimator();
}
renderInitial();

/* Keyboard shortcuts for convenience */
document.addEventListener('keydown', (e) => {
  if (e.key === 't') themePalette.classList.toggle('active');
  if (e.key === 'd' && !e.ctrlKey && !e.metaKey && !e.shiftKey && !e.altKey) {
    document.getElementById('btn-download').click();
  }
  if (e.key === 's' && e.ctrlKey) { e.preventDefault(); document.getElementById('btn-settings').click(); }
});


</script>
</body>
</html>
