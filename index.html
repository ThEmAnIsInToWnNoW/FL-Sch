<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Forest Lake ‚Äì Bell Schedule</title>
<style>
:root {
  --bg: #f4f4f9;
  --text: #222;
  --card: #fff;
  --accent: #800000;
  --accent-strong: #4CAF50;
  --border: #dcd7df;
  --muted: #666;
  --fab-red: #8b0000;
  --base-font-size: 16px;
}

html {
  font-size: var(--base-font-size);
}

html.auto-scale {
  font-size: clamp(12px, 1vw + 0.5vh, 20px);
}

.dark-mode {
  --bg: #0f1113;
  --text: #e6e6e6;
  --card: #131416;
  --accent: #b54b4b;
  --accent-strong: #66bb6a;
  --border: #222;
  --muted: #9aa0a6;
  --fab-red: #7a1f1f;
}

/* Theme presets */
.theme-ocean { --bg: #e3f2fd; --text: #01579b; --card: #fff; --accent: #0277bd; --accent-strong: #00acc1; --border: #b3e5fc; --muted: #546e7a; --fab-red: #01579b; }
.theme-forest { --bg: #e8f5e9; --text: #1b5e20; --card: #fff; --accent: #2e7d32; --accent-strong: #66bb6a; --border: #c8e6c9; --muted: #558b2f; --fab-red: #1b5e20; }
.theme-sunset { --bg: #fff3e0; --text: #e65100; --card: #fff; --accent: #f57c00; --accent-strong: #ff9800; --border: #ffe0b2; --muted: #ef6c00; --fab-red: #bf360c; }
.theme-lavender { --bg: #f3e5f5; --text: #4a148c; --card: #fff; --accent: #7b1fa2; --accent-strong: #ab47bc; --border: #e1bee7; --muted: #6a1b9a; --fab-red: #4a148c; }
.theme-mint { --bg: #e0f2f1; --text: #004d40; --card: #fff; --accent: #00695c; --accent-strong: #26a69a; --border: #b2dfdb; --muted: #00796b; --fab-red: #004d40; }
.theme-midnight { --bg: #0a0e27; --text: #e0e7ff; --card: #1a1f3a; --accent: #4c5fd5; --accent-strong: #6366f1; --border: #2d3250; --muted: #9ca3af; --fab-red: #4338ca; }
.theme-coffee { --bg: #1c1410; --text: #f5e6d3; --card: #2d241e; --accent: #8b4513; --accent-strong: #cd853f; --border: #3d342e; --muted: #a0826d; --fab-red: #5d2e0f; }
.theme-purple-haze { --bg: #1a0f2e; --text: #e9d5ff; --card: #2d1b4e; --accent: #7c3aed; --accent-strong: #a78bfa; --border: #3d2d5e; --muted: #c4b5fd; --fab-red: #5b21b6; }
.theme-teal-night { --bg: #0d1b2a; --text: #ccfbf1; --card: #1b2838; --accent: #0d9488; --accent-strong: #14b8a6; --border: #2d3f4e; --muted: #5eead4; --fab-red: #0f766e; }
.theme-burgundy { --bg: #1a0a0f; --text: #fce7f3; --card: #2d1a24; --accent: #9f1239; --accent-strong: #f43f5e; --border: #3d2a34; --muted: #fda4af; --fab-red: #881337; }

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}

.app {
  max-width: 1100px;
  margin: 28px auto;
  padding: 18px;
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 10px 30px rgba(20, 20, 30, 0.04);
}

header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
}

h1 {
  margin: 0;
  color: var(--accent);
  font-size: 1.3rem;
}

.meta {
  font-size: 0.9rem;
  color: var(--muted);
  margin-top: 6px;
}

.status-card {
  margin-top: 16px;
  padding: 14px;
  border-radius: 10px;
  border: 1px solid var(--border);
  display: flex;
  gap: 18px;
  align-items: center;
  flex-wrap: wrap;
}

#current-time {
  font-weight: 700;
  font-size: 1.2rem;
  color: var(--accent-strong);
  min-width: 120px;
}

.status-info {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex: 1;
}

#current-period {
  font-weight: 600;
}

#time-left-label {
  font-weight: bold;
}

#time-left {
  font-weight: normal;
  color: var(--accent-strong);
}

.local-text {
  margin-left: auto;
  font-size: 0.88rem;
  color: var(--muted);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 0.9rem;
}

th, td {
  padding: 8px 6px;
  border: 1px solid var(--border);
  text-align: left;
}

th {
  background: var(--accent);
  color: var(--card);
  text-transform: uppercase;
  font-size: 0.75rem;
  line-height: 1.3;
}

td.period-time {
  white-space: nowrap;
}

td.highlight {
  background: rgba(76, 175, 80, 0.10);
  font-weight: 700;
  color: var(--accent-strong);
  border: 2px solid rgba(76, 175, 80, 0.12);
}

/* Week calendar */
.week-wrap {
  margin-top: 12px;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  padding: 10px;
  background: var(--card);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.week-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 6px;
}

.nav {
  display: flex;
  gap: 6px;
  align-items: center;
}

#week-range {
  font-weight: 700;
  color: var(--muted);
  font-size: 0.9rem;
}

.week-grid {
  display: flex;
  gap: 6px;
  flex-wrap: nowrap;
  overflow-x: auto;
}

.day {
  flex: 1 1 0;
  border-radius: 8px;
  padding: 8px;
  border: 1px solid var(--border);
  min-width: 100px;
  background: var(--card);
}

.dh {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 700;
  margin-bottom: 6px;
  color: var(--accent);
  font-size: 0.9rem;
}

.date {
  font-size: 0.8rem;
  padding: 3px 6px;
  border-radius: 6px;
  background: rgba(0, 0, 0, 0.03);
  color: var(--muted);
}

.day.today {
  box-shadow: 0 0 0 3px var(--accent-strong) inset;
  border: 2px solid var(--accent-strong);
}

.events {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.ev {
  background: rgba(76, 175, 80, 0.08);
  padding: 5px 6px;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 0.8rem;
  color: var(--text);
  line-height: 1.3;
}

.ev.no-school {
  background: rgba(255, 87, 34, 0.1);
  border-color: rgba(255, 87, 34, 0.3);
  font-weight: 600;
}

.ev.small {
  opacity: 0.6;
  font-size: 0.75rem;
}

h2 {
  font-size: 1.1rem;
  margin: 14px 0 0 0;
}

/* Floating action button */
.fab-wrap {
  position: fixed;
  right: 20px;
  bottom: 20px;
  z-index: 1600;
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

#fab-main {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--fab-red);
  color: white;
  border: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  box-shadow: 0 14px 36px rgba(0, 0, 0, 0.25);
  cursor: pointer;
  transition: transform 0.2s;
}

#fab-main:hover {
  transform: scale(1.05);
}

.slide-layer {
  display: flex;
  gap: 8px;
  align-items: flex-end;
  pointer-events: none;
}

.slide-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  pointer-events: auto;
}

.slide-label {
  font-weight: 700;
  font-size: 0.7rem;
  margin-bottom: 2px;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity 0.28s, transform 0.28s;
  color: var(--muted);
}

.slide-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  border: 0;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
  cursor: pointer;
  font-size: 20px;
  transform: translateX(120%) scale(0.8);
  opacity: 0;
  filter: blur(8px);
  transition: transform 0.38s cubic-bezier(0.22, 0.9, 0.29, 1), opacity 0.28s, filter 0.38s;
}

.slide-btn.show {
  transform: translateX(0) scale(1);
  opacity: 1;
  filter: blur(0);
}

.slide-label.show {
  opacity: 1;
  transform: translateY(0);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-card {
  background: var(--card);
  border-radius: 12px;
  padding: 18px;
  border: 1px solid var(--border);
  width: 400px;
  max-width: 95%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-card h3 {
  margin-top: 0;
  color: var(--accent);
  font-size: 1.1rem;
}

.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.9rem;
}

.setting-row:last-child {
  border-bottom: none;
}

.btn {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  color: var(--text);
  transition: all 0.2s;
  font-size: 0.85rem;
}

.btn:hover {
  background: var(--border);
}

select, input[type="checkbox"] {
  padding: 6px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--card);
  color: var(--text);
}

/* Theme palette */
.theme-palette {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  z-index: 1700;
  transform: scale(0) translateY(20px);
  opacity: 0;
  transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s;
  pointer-events: none;
}

.theme-palette.active {
  transform: scale(1) translateY(0);
  opacity: 1;
  pointer-events: auto;
}

.theme-palette h4 {
  margin: 0 0 10px 0;
  color: var(--accent);
  font-size: 0.85rem;
}

.theme-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 6px;
}

.theme-option {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: transform 0.2s, border-color 0.2s;
}

.theme-option:hover {
  transform: scale(1.1);
}

.theme-option.active {
  border-color: var(--accent-strong);
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

/* Theme colors */
.theme-option[data-theme="default"] { background: linear-gradient(135deg, #f4f4f9 50%, #800000 50%); }
.theme-option[data-theme="dark-mode"] { background: linear-gradient(135deg, #0f1113 50%, #b54b4b 50%); }
.theme-option[data-theme="ocean"] { background: linear-gradient(135deg, #e3f2fd 50%, #0277bd 50%); }
.theme-option[data-theme="forest"] { background: linear-gradient(135deg, #e8f5e9 50%, #2e7d32 50%); }
.theme-option[data-theme="sunset"] { background: linear-gradient(135deg, #fff3e0 50%, #f57c00 50%); }
.theme-option[data-theme="lavender"] { background: linear-gradient(135deg, #f3e5f5 50%, #7b1fa2 50%); }
.theme-option[data-theme="mint"] { background: linear-gradient(135deg, #e0f2f1 50%, #00695c 50%); }
.theme-option[data-theme="midnight"] { background: linear-gradient(135deg, #0a0e27 50%, #4c5fd5 50%); }
.theme-option[data-theme="coffee"] { background: linear-gradient(135deg, #1c1410 50%, #8b4513 50%); }
.theme-option[data-theme="purple-haze"] { background: linear-gradient(135deg, #1a0f2e 50%, #7c3aed 50%); }

@media (max-width: 768px) {
  .status-card {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .local-text {
    margin-left: 0;
  }
  
  .week-head {
    flex-direction: column;
    align-items: stretch;
  }
  
  .week-head > div {
    width: 100%;
    justify-content: center;
  }
  
  #week-range {
    text-align: center;
    margin: 8px 0;
  }
  
  .week-grid {
    overflow-x: auto;
  }
  
  #fab-main {
    width: 56px;
    height: 56px;
    font-size: 26px;
  }
  
  .slide-btn {
    width: 48px;
    height: 48px;
  }
  
  .slide-label {
    display: none;
  }
  
  .theme-grid {
    grid-template-columns: repeat(5, 1fr);
  }
  
  table {
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 8px 4px;
  }
}
</style>
</head>
<body class="theme-default">
<div class="app">
  <header>
    <div>
      <h1>Forest Lake ‚Äì Bell Schedule</h1>
      <div class="meta">2025‚Äì2026 School Year</div>
    </div>
  </header>

  <div class="status-card">
    <div id="current-time">--:--:-- --</div>
    <div class="status-info">
      <div id="current-period">Loading schedule...</div>
      <div><span id="time-left-label">Time left:</span> <span id="time-left">--</span></div>
    </div>
    <div class="local-text">Local Time</div>
  </div>

  <section>
    <h2 style="margin-top: 20px; color: var(--accent);">Bell Schedule</h2>
    <table id="schedule-table">
      <thead>
        <tr>
          <th>Period</th>
          <th>Monday, Tuesday, Thursday, Friday</th>
          <th>Wednesday (Ranger Connect)</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>1</td><td class="period-time">7:45am - 8:35am</td><td class="period-time">7:45am - 8:30am</td></tr>
        <tr><td>2</td><td class="period-time">8:40am - 9:30am</td><td class="period-time">8:35am - 9:25am</td></tr>
        <tr><td>3</td><td class="period-time">9:35am - 10:25am</td><td class="period-time">9:30am - 10:15am</td></tr>
        <tr><td>4</td><td class="period-time">10:30am - 11:20am</td><td class="period-time">10:20am - 11:05am</td></tr>
        <tr><td>Ranger Connect</td><td class="period-time">-</td><td class="period-time">11:10am - 11:35am</td></tr>
        <tr><td>5</td><td class="period-time">11:25am - 12:40pm</td><td class="period-time">11:40am - 12:50pm</td></tr>
        <tr><td>A Lunch</td><td class="period-time">11:20am - 11:50am</td><td class="period-time">11:35am - 12:05pm</td></tr>
        <tr><td>B Lunch</td><td class="period-time">11:45am - 12:15pm</td><td class="period-time">12:00pm - 12:30pm</td></tr>
        <tr><td>C Lunch</td><td class="period-time">12:15pm - 12:45pm</td><td class="period-time">12:25pm - 12:55pm</td></tr>
        <tr><td>6</td><td class="period-time">12:45pm - 1:35pm</td><td class="period-time">12:55pm - 1:40pm</td></tr>
        <tr><td>7</td><td class="period-time">1:40pm - 2:30pm</td><td class="period-time">1:45pm - 2:30pm</td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <div style="text-align: center; margin-top: 20px;">
      <h2 style="margin: 0 0 10px 0; color: var(--accent);">School Events & Calendar</h2>
      <button class="btn" id="toggle-events-section">Show Events üìÖ</button>
    </div>
    <div id="events-section" style="display: none;">
      <div class="week-wrap">
        <div class="week-head">
          <div class="nav">
            <button class="btn" id="prev-week">‚Üê Prev</button>
            <button class="btn" id="next-week">Next ‚Üí</button>
          </div>
          <div id="week-range">Loading...</div>
          <div>
            <button class="btn" id="return-week" style="display:none">Current Week</button>
          </div>
        </div>
        <div id="week-grid" class="week-grid"></div>
      </div>
    </div>
  </section>
</div>

<div class="fab-wrap">
  <button id="fab-main" aria-label="Menu">+</button>
  <div class="slide-layer" id="slide-layer">
    <div class="slide-item">
      <div class="slide-label">Bookmark</div>
      <button class="slide-btn" id="btn-bookmark" title="Bookmark">üîñ</button>
    </div>
    <div class="slide-item">
      <div class="slide-label">Download</div>
      <button class="slide-btn" id="btn-download" title="Download">‚¨áÔ∏è</button>
    </div>
    <div class="slide-item">
      <div class="slide-label">Share</div>
      <button class="slide-btn" id="btn-share" title="Share">üì§</button>
    </div>
    <div class="slide-item">
      <div class="slide-label">Theme</div>
      <button class="slide-btn" id="btn-theme" title="Theme">üé®</button>
    </div>
    <div class="slide-item">
      <div class="slide-label">Settings</div>
      <button class="slide-btn" id="btn-settings" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
</div>

<div class="theme-palette" id="theme-palette">
  <h4>Choose Theme</h4>
  <div class="theme-grid">
    <div class="theme-option active" data-theme="default" title="Default"></div>
    <div class="theme-option" data-theme="ocean" title="Ocean"></div>
    <div class="theme-option" data-theme="forest" title="Forest"></div>
    <div class="theme-option" data-theme="sunset" title="Sunset"></div>
    <div class="theme-option" data-theme="lavender" title="Lavender"></div>
    <div class="theme-option" data-theme="mint" title="Mint"></div>
    <div class="theme-option" data-theme="midnight" title="Midnight"></div>
    <div class="theme-option" data-theme="coffee" title="Coffee"></div>
    <div class="theme-option" data-theme="purple-haze" title="Purple Haze"></div>
    <div class="theme-option" data-theme="dark-mode" title="Dark Mode"></div>
  </div>
</div>

<div class="modal" id="settings-modal">
  <div class="modal-card">
    <h3>‚öôÔ∏è Settings</h3>
    <div class="setting-row">
      <label>Time Format</label>
      <select id="time-format">
        <option value="12">12-hour</option>
        <option value="24">24-hour</option>
      </select>
    </div>
    <div class="setting-row">
      <label>Show Seconds</label>
      <input type="checkbox" id="show-seconds" checked>
    </div>
    <div class="setting-row">
      <label>Show Milliseconds</label>
      <input type="checkbox" id="show-milliseconds">
    </div>
    <div style="text-align: right; margin-top: 16px;">
      <button class="btn" id="close-settings">Close</button>
    </div>
  </div>
</div>

<script>
// School events data from FLAS 2025-2026 calendar
const SCHOOL_EVENTS = [
  { start: '2025-09-02', end: '2025-09-02', title: 'First day | K-5, 6, 9 & STEP' },
  { start: '2025-09-03', end: '2025-09-03', title: 'First day | 7, 10-12' },
  { start: '2025-09-04', end: '2025-09-04', title: 'First day | Grade 8' },
  
  { start: '2025-10-15', end: '2025-10-15', title: 'No School (K-5 only) | Elem conferences' },
  { start: '2025-10-16', end: '2025-10-17', title: 'No School | Fall break' },
  { start: '2025-10-31', end: '2025-10-31', title: 'End of Quarter 1' },
  
  { start: '2025-11-03', end: '2025-11-03', title: 'No School' },
  { start: '2025-11-26', end: '2025-11-28', title: 'No School | Thanksgiving Break' },
  
  { start: '2025-12-24', end: '2025-12-31', title: 'No School | Winter Break' },
  { start: '2026-01-01', end: '2026-01-02', title: 'No School | Winter Break' },
  { start: '2026-01-16', end: '2026-01-16', title: 'End of Quarter 2' },
  { start: '2026-01-19', end: '2026-01-20', title: 'No School' },
  
  { start: '2026-02-16', end: '2026-02-16', title: 'No School' },
  
  { start: '2026-03-06', end: '2026-03-06', title: 'No School (K-5 only) | Elem conferences' },
  { start: '2026-03-09', end: '2026-03-13', title: 'No School | Spring Break' },
  
  { start: '2026-04-01', end: '2026-04-01', title: 'End of Quarter 3' },
  { start: '2026-04-02', end: '2026-04-03', title: 'No School' },
  
  { start: '2026-05-04', end: '2026-05-04', title: 'No School' },
  { start: '2026-05-22', end: '2026-05-22', title: 'No School (K-5 only)' },
  { start: '2026-05-25', end: '2026-05-25', title: 'No School | Memorial Day' },
  
  { start: '2026-06-04', end: '2026-06-04', title: 'Last day | K-12 & STEP' }
];

// Helper functions
function parseISO(s) {
  const [y, m, d] = s.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function ymd(d) {
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function dateEq(a, b) {
  return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
}

function startOfWeek(d) {
  const c = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  let day = c.getDay();
  day = (day === 0 ? 7 : day);
  c.setDate(c.getDate() - (day - 1));
  return new Date(c.getFullYear(), c.getMonth(), c.getDate());
}

function addDays(d, n) {
  const r = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  r.setDate(r.getDate() + n);
  return r;
}

function eventsForDate(d) {
  return SCHOOL_EVENTS.filter(ev => {
    const s = parseISO(ev.start);
    const e = parseISO(ev.end);
    return ymd(s) <= ymd(d) && ymd(e) >= ymd(d);
  });
}

function formatRangeLabel(startDate, endDate) {
  const s = startDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  const e = endDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
  return `${s} ‚Äì ${e}`;
}

// Week calendar
let now = new Date();
let currentWeekStart = startOfWeek(now);
let viewingWeekStart = new Date(currentWeekStart);

function renderWeek(weekStart) {
  const weekGrid = document.getElementById('week-grid');
  const weekRange = document.getElementById('week-range');
  const returnBtn = document.getElementById('return-week');
  
  weekGrid.innerHTML = '';
  const start = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
  const end = addDays(start, 6);
  weekRange.textContent = formatRangeLabel(start, end);
  
  for (let i = 0; i < 7; i++) {
    const day = addDays(start, i);
    const cell = document.createElement('div');
    cell.className = 'day';
    if (dateEq(day, new Date())) cell.classList.add('today');
    
    const dh = document.createElement('div');
    dh.className = 'dh';
    const weekday = day.toLocaleDateString(undefined, { weekday: 'short' });
    const monthday = day.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    dh.innerHTML = `<div>${weekday}</div><div class="date">${monthday}</div>`;
    
    const evwrap = document.createElement('div');
    evwrap.className = 'events';
    const evs = eventsForDate(day);
    
    if (evs.length === 0) {
      const e = document.createElement('div');
      e.className = 'ev small';
      e.textContent = 'No events';
      evwrap.appendChild(e);
    } else {
      const shown = new Set();
      evs.forEach(ev => {
        const cleaned = ev.title.replace(/\s*\|\s*/g, ' | ');
        if (!shown.has(cleaned)) {
          const e = document.createElement('div');
          e.className = 'ev';
          if (cleaned.toLowerCase().includes('no school')) {
            e.classList.add('no-school');
          }
          e.textContent = cleaned;
          evwrap.appendChild(e);
          shown.add(cleaned);
        }
      });
    }
    
    cell.appendChild(dh);
    cell.appendChild(evwrap);
    weekGrid.appendChild(cell);
  }
  
  returnBtn.style.display = (ymd(weekStart) === ymd(currentWeekStart)) ? 'none' : 'inline-block';
}

document.getElementById('prev-week').addEventListener('click', () => {
  viewingWeekStart = addDays(viewingWeekStart, -7);
  renderWeek(viewingWeekStart);
});

document.getElementById('next-week').addEventListener('click', () => {
  viewingWeekStart = addDays(viewingWeekStart, 7);
  renderWeek(viewingWeekStart);
});

document.getElementById('return-week').addEventListener('click', () => {
  viewingWeekStart = new Date(currentWeekStart);
  renderWeek(viewingWeekStart);
});

// Toggle events section
document.getElementById('toggle-events-section').addEventListener('click', () => {
  const eventsSection = document.getElementById('events-section');
  const toggleBtn = document.getElementById('toggle-events-section');
  
  if (eventsSection.style.display === 'none') {
    eventsSection.style.display = 'block';
    toggleBtn.textContent = 'Hide Events üìÖ';
  } else {
    eventsSection.style.display = 'none';
    toggleBtn.textContent = 'Show Events üìÖ';
  }
});

// Schedule data
const SCHEDULE = [
  { period: "1", monFri: "7:45-8:35", wed: "7:45-8:30" },
  { period: "2", monFri: "8:40-9:30", wed: "8:35-9:25" },
  { period: "3", monFri: "9:35-10:25", wed: "9:30-10:15" },
  { period: "4", monFri: "10:30-11:20", wed: "10:20-11:05" },
  { period: "Ranger Connect", monFri: "", wed: "11:10-11:35" },
  { period: "5", monFri: "11:25-12:40", wed: "11:40-12:50" },
  { period: "A Lunch", monFri: "11:20-11:50", wed: "11:35-12:05" },
  { period: "B Lunch", monFri: "11:45-12:15", wed: "12:00-12:30" },
  { period: "C Lunch", monFri: "12:15-12:45", wed: "12:25-12:55" },
  { period: "6", monFri: "12:45-13:35", wed: "12:55-13:40" },
  { period: "7", monFri: "13:40-14:30", wed: "13:45-14:30" }
];

// Settings
let settings = {
  timeFormat: 12,
  showSeconds: true,
  showMilliseconds: false // NEW SETTING ADDED
};

// Helper functions
function timeToMinutes(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function formatCountdown(minutes) {
  if (minutes <= 0) return "0m 00s";
  const m = Math.floor(minutes);
  const s = Math.round((minutes - m) * 60);
  return `${m}m ${String(s).padStart(2, '0')}s`;
}

function formatTime(date) {
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  let ampm = '';
  
  // 12-hour format logic
  if (settings.timeFormat === 12) {
    ampm = hours >= 12 ? ' PM' : ' AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // The hour '0' should be '12'
  }
  
  // Custom: Hours are displayed without a leading zero for single digits
  const formattedHours = String(hours); // No leading zero is added here
  
  let timeString = `${formattedHours}:${minutes}`;
  
  if (settings.showSeconds) {
    timeString += `:${seconds}`;
  }

  if (settings.showMilliseconds) {
    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
    timeString += `.${milliseconds}`;
  }
  
  return timeString + ampm;
}

// Update schedule
function updateSchedule() {
  const now = new Date();
  document.getElementById('current-time').textContent = formatTime(now);
  
  const day = now.getDay();
  const isWeekend = (day === 0 || day === 6);
  const isWed = (day === 3);
  
  if (isWeekend) {
    document.getElementById('current-period').textContent = 'School is OUT ‚Äì Enjoy the weekend!';
    document.getElementById('time-left').textContent = '';
    highlightSchedule(null);
    return;
  }
  
  const nowMin = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
  const dayKey = isWed ? 'wed' : 'monFri';
  
  const applicable = SCHEDULE.filter(s => s[dayKey]).map(s => {
    const [start, end] = s[dayKey].split('-');
    return { ...s, startMin: timeToMinutes(start), endMin: timeToMinutes(end) };
  }).sort((a, b) => a.startMin - b.startMin);
  
  let current = null, next = null;
  for (const item of applicable) {
    if (nowMin >= item.startMin && nowMin < item.endMin) current = item;
    else if (nowMin < item.startMin && !next) next = item;
  }
  
  if (current) {
    const endTime = new Date();
    endTime.setHours(Math.floor(current.endMin / 60), current.endMin % 60, 0);
    document.getElementById('current-period').textContent = 
      `Current: Period ${current.period} (ends ${formatTime(endTime)})`;
    document.getElementById('time-left').textContent = formatCountdown(current.endMin - nowMin);
    highlightSchedule(current.period, isWed);
  } else if (next) {
    document.getElementById('current-period').textContent = 'Passing Time / Break';
    document.getElementById('time-left').textContent = 
      `Next: Period ${next.period} starts in ${formatCountdown(next.startMin - nowMin)}`;
    highlightSchedule(null);
  } else {
    document.getElementById('current-period').textContent = 'Before school hours';
    document.getElementById('time-left').textContent = 'School starts at 7:45 AM';
    highlightSchedule(null);
  }
}

function highlightSchedule(currentPeriod, isWed = false) {
  document.querySelectorAll('#schedule-table tbody td').forEach(td => td.classList.remove('highlight'));
  if (!currentPeriod) return;
  
  const rows = document.querySelectorAll('#schedule-table tbody tr');
  rows.forEach(row => {
    const p = row.cells[0].textContent.trim();
    if (p === currentPeriod) {
      const col = isWed ? 2 : 1;
      const cell = row.cells[col];
      if (cell) cell.classList.add('highlight');
    }
  });
}

// Menu controls
let menuOpen = false;
const fab = document.getElementById('fab-main');
const slideLayer = document.getElementById('slide-layer');
const slideItems = Array.from(document.querySelectorAll('.slide-item'));

function toggleMenu(open) {
  menuOpen = open;
  fab.textContent = open ? '‚úï' : '+';
  
  if (open) {
    slideItems.forEach((it, i) => {
      const btn = it.querySelector('.slide-btn');
      const label = it.querySelector('.slide-label');
      setTimeout(() => {
        btn.classList.add('show');
        label.classList.add('show');
      }, i * 80);
    });
  } else {
    slideItems.slice().reverse().forEach((it, idx) => {
      const btn = it.querySelector('.slide-btn');
      const label = it.querySelector('.slide-label');
      setTimeout(() => {
        btn.classList.remove('show');
        label.classList.remove('show');
      }, idx * 50);
    });
  }
}

fab.addEventListener('click', () => toggleMenu(!menuOpen));

document.addEventListener('click', (e) => {
  if (!document.querySelector('.fab-wrap').contains(e.target) && 
      !document.getElementById('theme-palette').contains(e.target) && 
      menuOpen) {
    toggleMenu(false);
    document.getElementById('theme-palette').classList.remove('active');
  }
});

// Settings modal
const settingsModal = document.getElementById('settings-modal');
document.getElementById('btn-settings').addEventListener('click', () => {
  toggleMenu(false);
  settingsModal.classList.add('active');
});

document.getElementById('close-settings').addEventListener('click', () => {
  settingsModal.classList.remove('active');
});

settingsModal.addEventListener('click', (e) => {
  if (e.target === settingsModal) {
    settingsModal.classList.remove('active');
  }
});

document.getElementById('time-format').addEventListener('change', (e) => {
  settings.timeFormat = parseInt(e.target.value);
  updateSchedule();
});

document.getElementById('show-seconds').addEventListener('change', (e) => {
  settings.showSeconds = e.target.checked;
  updateSchedule();
});

// NEW SETTING HANDLER ADDED
document.getElementById('show-milliseconds').addEventListener('change', (e) => {
  settings.showMilliseconds = e.target.checked;
  updateSchedule();
});

// Theme palette
const themePalette = document.getElementById('theme-palette');
const themeOptions = document.querySelectorAll('.theme-option');

document.getElementById('btn-theme').addEventListener('click', () => {
  toggleMenu(false);
  themePalette.classList.toggle('active');
});

themeOptions.forEach(option => {
  option.addEventListener('click', () => {
    const theme = option.dataset.theme;
    document.body.className = `theme-${theme}`;
    themeOptions.forEach(o => o.classList.remove('active'));
    option.classList.add('active');
    themePalette.classList.remove('active');
  });
});

// Share button
document.getElementById('btn-share').addEventListener('click', async () => {
  toggleMenu(false);
  const shareData = {
    title: document.title,
    text: 'Forest Lake Bell Schedule',
    url: location.href
  };
  
  if (navigator.share) {
    try {
      await navigator.share(shareData);
    } catch (e) {
      // User cancelled
    }
  } else {
    try {
      await navigator.clipboard.writeText(location.href);
      alert('Link copied to clipboard!');
    } catch (e) {
      alert('Copy failed: ' + e);
    }
  }
});

// Download button
document.getElementById('btn-download').addEventListener('click', () => {
  toggleMenu(false);
  const html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'forest-lake-schedule.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// Bookmark button
document.getElementById('btn-bookmark').addEventListener('click', () => {
  toggleMenu(false);
  try {
    if (window.external && ('AddFavorite' in window.external)) {
      window.external.AddFavorite(location.href, document.title);
      return;
    }
  } catch (e) {}
  alert('To bookmark this page: press Ctrl+D (Windows) or Cmd+D (Mac) in your browser.');
});

// Initialize
renderWeek(viewingWeekStart);
updateSchedule();
// INTERVAL CHANGED to 10ms for millisecond updates
setInterval(updateSchedule, 10);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 't') {
    themePalette.classList.toggle('active');
  }
  if (e.key === 'd') {
    document.getElementById('btn-download').click();
  }
  if (e.key === 's' && e.ctrlKey) {
    e.preventDefault();
    settingsModal.classList.add('active');
  }
});
</script>
</body>
</html>